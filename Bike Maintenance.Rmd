---
title: "Better Management of Bicycle Fleet"
output: 
  powerpoint_presentation:
      reference_doc: Bikes_Template.pptx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls(all=TRUE))

if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(tidymodels)) install.packages("tidymodels", repos = "http://cran.us.r-project.org")
if(!require(lubridate)) install.packages("lubridate", repos = "http://cran.us.r-project.org")
if(!require(ggthemes)) install.packages("ggthemes", repunios = "http://cran.us.r-project.org")
if(!require(patchwork)) install.packages("patchwork", repos = "http://cran.us.r-project.org")
if(!require(gridtext)) install.packages("gridtext", repos = "http://cran.us.r-project.org")
if(!require(grid)) install.packages("grid", repos = "http://cran.us.r-project.org")

library(tidyverse)
library(tidymodels)
library(lubridate)
library(ggthemes)
library(patchwork)
library(grid)
library(gridtext)


## Data dictionary for original file
#- instant: record index
#- dteday : date
#- season : season (1:winter, 2:spring, 3:summer, 4:fall)
#- yr : year (0: 2011, 1:2012)
#- mnth : month ( 1 to 12)
#- hr : hour (0 to 23)
#- holiday : weather day is holiday or not (extracted from [Web Link])
#- weekday : day of the week
#- workingday : if day is neither weekend nor holiday is 1, otherwise is 0.
#+ weathersit :
#- 1: Clear, Few clouds, Partly cloudy, Partly cloudy
#- 2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist
#- 3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
#- 4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog
#- temp : Normalized temperature in Celsius. The values are derived via (t-t_min)/(t_max-t_min), t_min=-8, t_max=+39 (only in hourly scale)
#- atemp: Normalized feeling temperature in Celsius. The values are derived via (t-t_min)/(t_max-t_min), t_min=-16, t_max=+50 (only in hourly scale)
#- hum: Normalized humidity. The values are divided to 100 (max)
#- windspeed: Normalized wind speed. The values are divided to 67 (max)
#- casual: count of casual users
#- registered: count of registered users
#- cnt: count of total rental bikes including both casual and registered 

## variables for calculation

### Heat Index Model - https://en.wikipedia.org/wiki/Heat_index

    c1 = -8.78469475556
    c2 = 1.61139411
    c3 = 2.33854883889
    c4 = -0.14611605
    c5 = -0.012308094
    c6 = -0.0164248277778
    c7 = 0.002211732
    c8 = 0.00072546
    c9 = -0.000003582
    
    
#Windchill model    - https://en.wikipedia.org/wiki/Wind_chill
    w1<-13.1
    w2<-0.6215
    w3<-11.37
    w4<-0.3965
    
#Data de-normalisation
    
    t_min <- -8
    t_max <- 39
    h_max<-100
    
#Auxiliary Data
    
seasons <- tibble(season=1:4,
                  season_name=c("winter","spring","summer","autumn"))
weather_situation <- tibble(weathersit=1:4,
                            situation=c("Clear, Few clouds, Partly cloudy, Partly cloudy",
                                        "Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist",
                                        "Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds",
                                        "Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog"),
                good_wsit=c(TRUE,TRUE,FALSE,FALSE))
    

```

```{r get_data,include=FALSE}

###only get data if does not exist already in rds file

if(!(file.exists("bike_data.rds"))){

    temp <- tempfile()
    url <- "https://archive.ics.uci.edu/ml/machine-learning-databases/00275/Bike-Sharing-Dataset.zip"

    download.file(url,temp,method='wget')
    bike_data <- read_csv(unz(temp, "hour.csv"))
    saveRDS(bike_data,file="bike_data.rds")
    unlink(temp)

}else{
  bike_data<-readRDS("bike_data.rds")
}
```


```{r edit_data, include=FALSE}
bike_mod <- bike_data %>% group_by(dteday) %>% summarise(casual=sum(casual),
                                             registered=sum(registered),
                                             total=casual+registered,
                                             avg_temp=mean(temp)*(t_max-t_min)+t_min,
                                             min_temp=min(temp)*(t_max-t_min)+t_min,
                                             max_temp=max(temp)*(t_max-t_min)+t_min,
                                             avg_hum=mean(hum),
                                             min_hum=min(hum),
                                             max_hum=max(hum),
                                             avg_windspeed=mean(windspeed)*67,
                                             max_windspeed=max(windspeed)*67,
                                             med_windspeed=median(windspeed)*67,
                                             weathersit=max(weathersit),
                                             season=max(season),
                                             holiday=max(holiday)) %>%
  mutate(HI=c1+c2*max_temp+c3*avg_hum+c4*max_temp*avg_hum+c5*max_temp^2+
                             c6+avg_hum^2+c7*max_temp^2*avg_hum+c8*max_temp*avg_hum^2+
                             c9*max_temp^2*avg_hum^2,
         wc=w1+w2*min_temp-w3*max_windspeed^(0.16)+w4*min_temp*max_windspeed^(0.16),
         too_hot=(HI>=32),
         too_cold=(wc<0),
         too_windy=(med_windspeed>20),
         too_rainy=(max_hum>0.9))  %>%
  ungroup() %>%
   left_join(seasons,by="season") %>% left_join(weather_situation,by="weathersit") %>%
  mutate(day=wday(dteday,label=TRUE),
         day_nbr=wday(dteday,label=FALSE),
         month=month(dteday,label=TRUE),
         holiday=(holiday==1)) %>%
  mutate(Weather=ifelse(!too_hot & !too_cold & !too_windy & !too_rainy,'Good','Bad')) %>%
  select(-total) %>% pivot_longer(2:3,names_to="type",values_to="quantity") 
  
bike_mod$Weather <-  factor(bike_mod$Weather, levels=c('Good','Bad'))
bike_mod$type <-  factor(bike_mod$type, levels=c('registered','casual'))
bike_mod$season_name <-  factor(bike_mod$season_name, levels=c('winter','spring','summer','autumn'))
```

## Fleet maintenance volumes and windows need to be carefully chosen
:::::: {.columns}
::: {.column width="40%"}

In order to **<span style='color:brown;'>provide a good service</span>** for the users of the bike sharing scheme, **<span style='color:brown;'>unavailability needs to be avoided</span>**. Unavailability is caused by lack of maintenance or lack of supply. Thus, maintenance windows need to be selected **<span style='color:brown;'>smartly</span>**.

- Shared bikes are **<span style='color:brown;'>used every day of the week</span>**. Registered users provide a constant demand baseline.
- There is **<span style='color:brown;'>some seasonality</span>** in the demand: registered users brave through the winter keeping the numbers high.
- At first look, it seems that **<span style='color:brown;'>weather conditions are the biggest deterrent</span>** for bike usage. If it is too cold, or too hot or too windy casual users won't ride; registered users' numbers will also drop.
- Bikes will **<span style='color:brown;'>keep breaking</span>** - even if they are well built! Thus, **<span style='color:brown;'>every opportunity</span>** to undertake maintenance **<span style='color:brown;'>needs to be taken</span>**.
:::
::: {.column width="60%"}
```{r problem_statement_chart,dpi = 800, dev.args = list(bg = 'transparent'), echo = FALSE}

text_value <-   "**<span style='color:brown;'>Challenge</span>**: Using data analytics, we can leverage the **<span style='color:brown;'>weather forecast </span>** to optimise the fleet **<span style='color:brown;'>maintenace without compromising availibilty SLAs</span>**."

g <-bike_mod %>%
  ggplot(aes(x=day,y=quantity,color=Weather, group=1)) +
  geom_jitter(shape=16, position=position_jitter(0.2)) +
  facet_grid(type ~ season_name, space='free_y') +
 theme_fivethirtyeight() + 
  scale_shape_tableau() +
  scale_colour_tableau('Classic Color Blind') +
  scale_y_continuous(labels = comma) +
  theme(legend.position = "bottom",
        plot.title = element_text(size=14),
        axis.title.x = element_text(size = 10),
        axis.text.x = element_text(angle = 90, hjust = 1,size = 8),
        axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8, angle = 90),
        legend.title=element_text(size=8),
        legend.text=element_text(size=8)) +
  labs(title="Bike Demand per Season and User Type",
       x="Day of the Week",
       y="Bikes Rented") +
  guides(col = guide_legend(ncol = 2),fill = guide_legend(title = "Weather", title.position = "left"))


t<-  textbox_grob(
  text_value,
  gp = gpar(fontsize = 12),
  box_gp = gpar(col = "grey80", fill = NA,lineend="round",lwd=3),
  r = unit(10, "pt"),
  padding = unit(c(10, 10, 10, 10), "pt"),
  width = unit(1, "npc"),
#  height  = unit(1, "npc"),
  margin = unit(c(10, 10,10, 10), "pt")
)

layout <- "
AAAA
AAAA
AAAA
AAAA
AAAA
####
CCCC
CCCC
"
g + t + plot_layout(design = layout) 



```

:::
::::::

